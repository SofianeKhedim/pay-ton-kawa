# .github/workflows/ci-cd.yml

name: PayeTonKawa CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # DÃ©tection des changements
  detect-changes:
    runs-on: ubuntu-latest
    name: Detect Changes
    outputs:
      client-api: ${{ steps.changes.outputs.client-api }}
      order-service: ${{ steps.changes.outputs.order-service }}
      product-service: ${{ steps.changes.outputs.product-service }}
      any-changes: ${{ steps.changes.outputs.any-changes }}
    steps:
    - name: ðŸ” Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
        
    - name: ðŸ” Detect changes
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          client-api:
            - 'client-api/**'
          order-service:
            - 'order-service/**'
          product-service:
            - 'product-service/**'
          any-changes:
            - 'client-api/**'
            - 'order-service/**'
            - 'product-service/**'

  # Tests Client API (Gradle)
  test-client-api:
    runs-on: ubuntu-latest
    name: Client API Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.client-api == 'true'
    
    steps:
    - name: ðŸ” Checkout code
      uses: actions/checkout@v4
      
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ’¾ Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-client-api-${{ hashFiles('client-api/**/*.gradle*', 'client-api/**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-client-api-
          
    - name: ðŸ§ª Run Client API tests
      working-directory: ./client-api
      run: |
        chmod +x gradlew
        ./gradlew test -Dspring.profiles.active=test
        
    - name: ðŸ“Š Generate test report
      working-directory: ./client-api
      if: always()
      run: ./gradlew jacocoTestReport
      
    - name: ðŸ“¤ Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: client-api-test-results
        path: |
          client-api/build/reports/tests/test/
          client-api/build/reports/jacoco/test/html/

  # Tests Product Service (Maven)
  test-product-service:
    runs-on: ubuntu-latest
    name: Product Service Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.product-service == 'true'
    
    steps:
    - name: ðŸ” Checkout code
      uses: actions/checkout@v4
      
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ’¾ Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-product-${{ hashFiles('product-service/**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-m2-product-
          
    - name: ðŸ§ª Run Product Service tests
      working-directory: ./product-service
      run: |
        if [ -f "mvnw" ]; then
          chmod +x mvnw
          ./mvnw clean test
        else
          mvn clean test
        fi
        
    - name: ðŸ“¤ Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: product-service-test-results
        path: product-service/target/surefire-reports/

  # Tests Order Service (Node.js)
  test-order-service:
    runs-on: ubuntu-latest
    name: Order Service Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.order-service == 'true'
    
    services:
      mongodb:
        image: mongo:5.0
        env:
          MONGO_INITDB_ROOT_USERNAME: root
          MONGO_INITDB_ROOT_PASSWORD: password
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: ðŸ” Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: order-service/package-lock.json
        
    - name: ðŸ“¦ Install dependencies
      working-directory: ./order-service
      run: npm ci
      
    - name: ðŸ§ª Run Order Service tests
      working-directory: ./order-service
      run: npm test
      env:
        NODE_ENV: test
        MONGODB_URI: mongodb://root:password@localhost:27017/test?authSource=admin
        JWT_SECRET: test-secret-key-for-ci
        
    - name: ðŸ“¤ Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: order-service-test-results
        path: |
          order-service/coverage/
          order-service/test-results.xml

  # Build des services modifiÃ©s
  build-services:
    runs-on: ubuntu-latest
    name: Build Services
    needs: [detect-changes, test-client-api, test-product-service, test-order-service]
    if: always() && needs.detect-changes.outputs.any-changes == 'true'
    
    steps:
    - name: ðŸ” Checkout code
      uses: actions/checkout@v4
      
    # Build Client API si modifiÃ©
    - name: â˜• Set up JDK 17
      if: needs.detect-changes.outputs.client-api == 'true' || needs.detect-changes.outputs.product-service == 'true'
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ”¨ Build Client API
      if: needs.detect-changes.outputs.client-api == 'true'
      working-directory: ./client-api
      run: |
        chmod +x gradlew
        ./gradlew clean bootJar -x test
        echo "âœ… Client API built successfully"
        
    - name: ðŸ”¨ Build Product Service
      if: needs.detect-changes.outputs.product-service == 'true'
      working-directory: ./product-service
      run: |
        if [ -f "mvnw" ]; then
          chmod +x mvnw
          ./mvnw clean package -DskipTests
        else
          mvn clean package -DskipTests
        fi
        echo "âœ… Product Service built successfully"
        
    # Build Order Service si modifiÃ©
    - name: ðŸŸ¢ Set up Node.js
      if: needs.detect-changes.outputs.order-service == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: order-service/package-lock.json
        
    - name: ðŸ”¨ Build Order Service
      if: needs.detect-changes.outputs.order-service == 'true'
      working-directory: ./order-service
      run: |
        npm ci --production
        echo "âœ… Order Service built successfully"

  # DÃ‰PLOIEMENT - Seulement si push sur main ET tous les tests passent
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Digital Ocean
    needs: [detect-changes, test-client-api, test-product-service, test-order-service, build-services]
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' && 
      needs.detect-changes.outputs.any-changes == 'true' &&
      (needs.test-client-api.result == 'success' || needs.test-client-api.result == 'skipped') &&
      (needs.test-product-service.result == 'success' || needs.test-product-service.result == 'skipped') &&
      (needs.test-order-service.result == 'success' || needs.test-order-service.result == 'skipped') &&
      needs.build-services.result == 'success'
    
    steps:
    - name: ðŸš€ Deploy to Digital Ocean
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DROPLET_IP }}
        username: ${{ secrets.DROPLET_USER }}
        password: ${{ secrets.DROPLET_PASSWORD }}
        script: |
          echo "ðŸš€ DÃ©marrage du dÃ©ploiement..."
          
          cd /root/pay-ton-kawa
          git pull origin main
          
          SERVICES_TO_DEPLOY=""
          
          # VÃ©rifier quels services ont changÃ©
          if [ "${{ needs.detect-changes.outputs.client-api }}" == "true" ]; then
            echo "ðŸ”„ Client API modifiÃ©"
            SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY client-api-app"
          fi
          
          if [ "${{ needs.detect-changes.outputs.order-service }}" == "true" ]; then
            echo "ðŸ”„ Order Service modifiÃ©"
            SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY order-service"
          fi
          
          if [ "${{ needs.detect-changes.outputs.product-service }}" == "true" ]; then
            echo "ðŸ”„ Product Service modifiÃ©"
            SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY product-service"
          fi
          
          if [ -z "$SERVICES_TO_DEPLOY" ]; then
            echo "â„¹ï¸ Aucun service Ã  redÃ©ployer"
            exit 0
          fi
          
          echo "ðŸ”¨ Rebuild des services modifiÃ©s: $SERVICES_TO_DEPLOY"
          docker-compose build $SERVICES_TO_DEPLOY
          
          echo "â™»ï¸ RedÃ©ploiement des services: $SERVICES_TO_DEPLOY"
          docker-compose stop $SERVICES_TO_DEPLOY
          docker-compose rm -f $SERVICES_TO_DEPLOY
          docker-compose up -d $SERVICES_TO_DEPLOY
          
          echo "â³ Attente stabilisation..."
          sleep 30
          
          echo "ðŸ“Š Ã‰tat des services:"
          docker-compose ps
          
          echo "âœ… DÃ©ploiement sÃ©lectif terminÃ© !"

  # Validation finale
  deployment-validation:
    runs-on: ubuntu-latest
    name: Deployment Validation
    needs: [deploy]
    if: always() && needs.deploy.result == 'success'
    
    steps:
    - name: âœ… Deployment Success
      run: |
        echo "ðŸŽ‰ DÃ©ploiement rÃ©ussi !"
        echo "Services dÃ©ployÃ©s avec succÃ¨s sur Digital Ocean"
        echo "URL: https://votre-domaine.com"

  # Rapport final
  final-report:
    runs-on: ubuntu-latest
    name: Final Report
    needs: [detect-changes, deploy]
    if: always()
    
    steps:
    - name: ðŸ“‹ Generate Final Report
      run: |
        echo "# ðŸš€ Rapport de CI/CD PayeTonKawa" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š RÃ©sumÃ© des changements" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.detect-changes.outputs.client-api }}" == "true" ]; then
          echo "- âœ… Client API modifiÃ© et traitÃ©" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "${{ needs.detect-changes.outputs.product-service }}" == "true" ]; then
          echo "- âœ… Product Service modifiÃ© et traitÃ©" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "${{ needs.detect-changes.outputs.order-service }}" == "true" ]; then
          echo "- âœ… Order Service modifiÃ© et traitÃ©" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ¯ RÃ©sultat du dÃ©ploiement" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… **DÃ©ploiement rÃ©ussi** sur Digital Ocean" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
          echo "â­ï¸ **DÃ©ploiement ignorÃ©** (pas de push sur main ou pas de changements)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **DÃ©ploiement Ã©chouÃ©** - VÃ©rifiez les logs" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*GÃ©nÃ©rÃ© le $(date) par GitHub Actions*" >> $GITHUB_STEP_SUMMARY
