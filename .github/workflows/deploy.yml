# .github/workflows/ci.yml

name: PayeTonKawa CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # DÃ©tection des changements (mÃªme logique que le CD)
  detect-changes:
    runs-on: ubuntu-latest
    name: ðŸ” Detect Changes
    outputs:
      client-api: ${{ steps.changes.outputs.client-api }}
      order-service: ${{ steps.changes.outputs.order-service }}
      product-service: ${{ steps.changes.outputs.product-service }}
      any-changes: ${{ steps.changes.outputs.any-changes }}
    steps:
    - name: ðŸ” Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
        
    - name: ðŸ” Detect changes
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          client-api:
            - 'client-api/**'
          order-service:
            - 'order-service/**'
          product-service:
            - 'product-service/**'
          any-changes:
            - 'client-api/**'
            - 'order-service/**'
            - 'product-service/**'

  # Tests Client API (seulement si modifiÃ©)
  test-client-api:
    runs-on: ubuntu-latest
    name: ðŸ” Client API Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.client-api == 'true'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ“¦ Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-client-api-${{ hashFiles('client-api/**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-m2-client-api-
          ${{ runner.os }}-m2-
        
    - name: ðŸ§ª Run Client API tests
      working-directory: ./client-api
      run: |
        chmod +x mvnw
        ./mvnw clean test -Dspring.profiles.active=test
        
    - name: ðŸ“Š Generate test report
      working-directory: ./client-api
      if: always()
      run: ./mvnw surefire-report:report
      
    - name: ðŸ“¤ Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: client-api-test-results
        path: |
          client-api/target/surefire-reports/
          client-api/target/site/surefire-report.html

  # Tests Product Service (seulement si modifiÃ©)
  test-product-service:
    runs-on: ubuntu-latest
    name: ðŸ“¦ Product Service Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.product-service == 'true'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ“¦ Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-product-${{ hashFiles('product-service/**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-m2-product-
          ${{ runner.os }}-m2-
        
    - name: ðŸ§ª Run Product Service tests
      working-directory: ./product-service
      run: |
        chmod +x mvnw
        ./mvnw clean test -Dspring.profiles.active=test
        
    - name: ðŸ“¤ Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: product-service-test-results
        path: product-service/target/surefire-reports/

  # Tests Order Service (seulement si modifiÃ©)
  test-order-service:
    runs-on: ubuntu-latest
    name: ðŸ›’ Order Service Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.order-service == 'true'
    
    services:
      mongodb:
        image: mongo:5.0
        env:
          MONGO_INITDB_ROOT_USERNAME: root
          MONGO_INITDB_ROOT_PASSWORD: password
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: order-service/package-lock.json
        
    - name: ðŸ“¦ Install dependencies
      working-directory: ./order-service
      run: npm ci
      
    - name: ðŸ§ª Run Order Service tests
      working-directory: ./order-service
      run: npm test
      env:
        NODE_ENV: test
        MONGODB_URI: mongodb://root:password@localhost:27017/test?authSource=admin
        JWT_SECRET: test-secret-key-for-ci
        
    - name: ðŸ“¤ Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: order-service-test-results
        path: |
          order-service/coverage/
          order-service/test-results.xml

  # Build check (seulement pour les services modifiÃ©s)
  build-check:
    runs-on: ubuntu-latest
    name: ðŸ—ï¸ Build Check
    needs: [detect-changes, test-client-api, test-product-service, test-order-service]
    if: always() && needs.detect-changes.outputs.any-changes == 'true'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    # Build Client API si modifiÃ©
    - name: â˜• Set up JDK 17
      if: needs.detect-changes.outputs.client-api == 'true' || needs.detect-changes.outputs.product-service == 'true'
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ—ï¸ Build Client API
      if: needs.detect-changes.outputs.client-api == 'true'
      working-directory: ./client-api
      run: |
        chmod +x mvnw
        ./mvnw clean package -DskipTests
        echo "âœ… Client API built successfully"
        
    - name: ðŸ—ï¸ Build Product Service
      if: needs.detect-changes.outputs.product-service == 'true'
      working-directory: ./product-service
      run: |
        chmod +x mvnw
        ./mvnw clean package -DskipTests
        echo "âœ… Product Service built successfully"
        
    # Build Order Service si modifiÃ©
    - name: ðŸŸ¢ Set up Node.js
      if: needs.detect-changes.outputs.order-service == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: order-service/package-lock.json
        
    - name: ðŸ—ï¸ Build Order Service
      if: needs.detect-changes.outputs.order-service == 'true'
      working-directory: ./order-service
      run: |
        npm ci --production
        echo "âœ… Order Service built successfully"
        
    - name: âœ… Build Summary
      run: |
        echo "ðŸŽ‰ Build Summary:"
        if [ "${{ needs.detect-changes.outputs.client-api }}" == "true" ]; then
          echo "âœ… Client API: Built successfully"
        fi
        if [ "${{ needs.detect-changes.outputs.product-service }}" == "true" ]; then
          echo "âœ… Product Service: Built successfully"
        fi
        if [ "${{ needs.detect-changes.outputs.order-service }}" == "true" ]; then
          echo "âœ… Order Service: Built successfully"
        fi

  # Test de validation finale
  validation:
    runs-on: ubuntu-latest
    name: âœ… Final Validation
    needs: [detect-changes, test-client-api, test-product-service, test-order-service, build-check]
    if: always() && needs.detect-changes.outputs.any-changes == 'true'
    
    steps:
    - name: ðŸ” Check test results
      run: |
        echo "ðŸ“Š Validation des rÃ©sultats de tests:"
        
        # VÃ©rifier Client API
        if [ "${{ needs.detect-changes.outputs.client-api }}" == "true" ]; then
          if [ "${{ needs.test-client-api.result }}" == "success" ]; then
            echo "âœ… Client API: Tests passed"
          else
            echo "âŒ Client API: Tests failed"
            exit 1
          fi
        fi
        
        # VÃ©rifier Product Service
        if [ "${{ needs.detect-changes.outputs.product-service }}" == "true" ]; then
          if [ "${{ needs.test-product-service.result }}" == "success" ]; then
            echo "âœ… Product Service: Tests passed"
          else
            echo "âŒ Product Service: Tests failed"
            exit 1
          fi
        fi
        
        # VÃ©rifier Order Service
        if [ "${{ needs.detect-changes.outputs.order-service }}" == "true" ]; then
          if [ "${{ needs.test-order-service.result }}" == "success" ]; then
            echo "âœ… Order Service: Tests passed"
          else
            echo "âŒ Order Service: Tests failed"
            exit 1
          fi
        fi
        
        echo "ðŸŽ‰ Tous les tests sont passÃ©s ! PrÃªt pour le dÃ©ploiement."

  # Rapport final
  ci-summary:
    runs-on: ubuntu-latest
    name: ðŸ“‹ CI Summary
    needs: [detect-changes, validation]
    if: always()
    
    steps:
    - name: ðŸ“‹ Generate CI Summary
      run: |
        echo "# ðŸ“‹ CI Summary Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ” Changes Detected:" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.detect-changes.outputs.client-api }}" == "true" ]; then
          echo "- âœ… Client API modified" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "${{ needs.detect-changes.outputs.product-service }}" == "true" ]; then
          echo "- âœ… Product Service modified" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "${{ needs.detect-changes.outputs.order-service }}" == "true" ]; then
          echo "- âœ… Order Service modified" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.detect-changes.outputs.any-changes }}" != "true" ]; then
          echo "- â„¹ï¸ No services modified" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸš€ Ready for Deployment" >> $GITHUB_STEP_SUMMARY
        echo "Les services modifiÃ©s sont prÃªts pour le dÃ©ploiement automatique." >> $GITHUB_STEP_SUMMARY
